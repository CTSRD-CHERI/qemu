name: Check coding style
on: [pull_request]
jobs:
  check-format:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Try to fetch required commits
        run: |
          set -xe
          # Based on https://stackoverflow.com/questions/54181901/fetching-only-the-range-of-commits-not-present-in-base-branch
          git fetch "--depth=2" origin "${{ github.base_ref }}:${{ github.base_ref }}"
          for ((depth = 8; depth <= 65536; depth *= 2)); do
              echo "trying depth $depth ..."
              git fetch "--depth=$depth" origin "+${{ github.sha }}"
              if git merge-base --is-ancestor "${{ github.base_ref }}" HEAD; then
                  echo "found with depth=$depth"
                  break
              fi
          done
      - run: git --no-pager log --oneline -100
      - run: git remote -v
      - run: git show --stat "${{ github.sha }}" || true
      - run: git show --stat "${{ github.base_ref }}" || true
      - run: git show --stat "origin/${{ github.base_ref }}" || true
      - name: checkpatch.pl
        run: ./scripts/checkpatch.pl --no-signoff --branch "origin/${{ github.base_ref }}..${{ github.sha }}"
      - name: Check clang-format
        uses: wolletd/clang-format-checker@v1
        with:
          target-ref: "${{ github.base_ref }}" # required, merge target
          clang-version: 12     # optional, default: 12
          
